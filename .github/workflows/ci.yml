name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'

jobs:
  validate:
    name: Validate Rainmeter Measures
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        # Ensure line endings are handled correctly
        persist-credentials: false
      
    - name: Set up environment
      run: |
        # Set UTF-8 locale to handle different encodings
        echo "LANG=C.UTF-8" >> $GITHUB_ENV
        echo "LC_ALL=C.UTF-8" >> $GITHUB_ENV
        
    - name: Find Weather Measure Files
      id: find_files
      run: |
        echo "Finding weather measure files..."
        echo "Current directory: $(pwd)"
        echo "All files:"
        find . -type f -not -path "./.git/*" | sort
        
        # Find the actual paths to the files
        CURRENT_FILE=$(find . -name "CurrentForecast.inc" -type f | head -1)
        DAILY_FILE=$(find . -name "7DaysForecast.inc" -type f | head -1)
        HOURLY_FILE=$(find . -name "7HoursForecast.inc" -type f | head -1)
        
        echo "CURRENT_FILE=$CURRENT_FILE" >> $GITHUB_ENV
        echo "DAILY_FILE=$DAILY_FILE" >> $GITHUB_ENV
        echo "HOURLY_FILE=$HOURLY_FILE" >> $GITHUB_ENV
        
        if [ -n "$CURRENT_FILE" ]; then
          echo "✓ Found CurrentForecast.inc at $CURRENT_FILE"
        else
          echo "✗ Could not find CurrentForecast.inc"
          exit 1
        fi
        
        if [ -n "$DAILY_FILE" ]; then
          echo "✓ Found 7DaysForecast.inc at $DAILY_FILE"
        else
          echo "✗ Could not find 7DaysForecast.inc"
          exit 1
        fi
        
        if [ -n "$HOURLY_FILE" ]; then
          echo "✓ Found 7HoursForecast.inc at $HOURLY_FILE"
        else
          echo "✗ Could not find 7HoursForecast.inc"
          exit 1
        fi
      
    - name: Validate Current Forecast Measures
      run: |
        echo "Validating CurrentForecast.inc at path: $CURRENT_FILE"
        
        # Convert UTF-16 to UTF-8 if needed
        if file "$CURRENT_FILE" | grep -q "UTF-16"; then
          echo "Converting UTF-16 to UTF-8"
          TEMP_FILE=$(mktemp)
          iconv -f UTF-16LE -t UTF-8 "$CURRENT_FILE" > "$TEMP_FILE"
          CURRENT_FILE_UTF8="$TEMP_FILE"
        else
          CURRENT_FILE_UTF8="$CURRENT_FILE"
        fi
        
        # Check for required measures using UTF-8 converted file
        if ! grep -q "Measure_Weather_Current_Parent" "$CURRENT_FILE_UTF8"; then
          echo "ERROR: Missing parent measure in CurrentForecast.inc"
          echo "Showing first 30 lines of file for debugging:"
          head -30 "$CURRENT_FILE_UTF8"
          exit 1
        fi
        echo "✓ Parent measure found"
        
        # Check for essential child measures
        measures=("Measure_Current_Temperature" "Measure_Current_Weather_Code" "Measure_Is_Day")
        for measure in "${measures[@]}"; do
          if grep -q "$measure" "$CURRENT_FILE_UTF8"; then
            echo "✓ $measure found"
          else
            echo "ERROR: Missing $measure in CurrentForecast.inc"
            echo "Showing lines containing 'Measure_' for debugging:"
            grep -n "Measure_" "$CURRENT_FILE_UTF8" | head -20
            exit 1
          fi
        done
        
    - name: Validate 7-Day Forecast Measures
      run: |
        echo "Validating 7DaysForecast.inc at path: $DAILY_FILE"
        
        # Convert UTF-16 to UTF-8 if needed
        if file "$DAILY_FILE" | grep -q "UTF-16"; then
          echo "Converting UTF-16 to UTF-8"
          TEMP_FILE=$(mktemp)
          iconv -f UTF-16LE -t UTF-8 "$DAILY_FILE" > "$TEMP_FILE"
          DAILY_FILE_UTF8="$TEMP_FILE"
        else
          DAILY_FILE_UTF8="$DAILY_FILE"
        fi
        
        # Check for required measures
        if ! grep -q "Measure_Weather_Daily_Parent" "$DAILY_FILE_UTF8"; then
          echo "ERROR: Missing parent measure in 7DaysForecast.inc"
          echo "Showing first 30 lines of file for debugging:"
          head -30 "$DAILY_FILE_UTF8"
          exit 1
        fi
        echo "✓ Parent measure found"
        
        # Check for day 1 measures as sample
        measures=("Measure_Day1_Date" "Measure_Day1_Max_Temperature" "Measure_Day1_Min_Temperature" "Measure_Day1_Weather_Code")
        for measure in "${measures[@]}"; do
          if grep -q "$measure" "$DAILY_FILE_UTF8"; then
            echo "✓ $measure found"
          else
            echo "ERROR: Missing $measure in 7DaysForecast.inc"
            echo "Showing lines containing 'Measure_' for debugging:"
            grep -n "Measure_" "$DAILY_FILE_UTF8" | head -20
            exit 1
          fi
        done
        
    - name: Validate 7-Hour Forecast Measures
      run: |
        echo "Validating 7HoursForecast.inc at path: $HOURLY_FILE"
        
        # Convert UTF-16 to UTF-8 if needed
        if file "$HOURLY_FILE" | grep -q "UTF-16"; then
          echo "Converting UTF-16 to UTF-8"
          TEMP_FILE=$(mktemp)
          iconv -f UTF-16LE -t UTF-8 "$HOURLY_FILE" > "$TEMP_FILE"
          HOURLY_FILE_UTF8="$TEMP_FILE"
        else
          HOURLY_FILE_UTF8="$HOURLY_FILE"
        fi
        
        # Check for required measures
        if ! grep -q "Measure_Weather_Hourly_Parent" "$HOURLY_FILE_UTF8"; then
          echo "ERROR: Missing parent measure in 7HoursForecast.inc"
          echo "Showing first 30 lines of file for debugging:"
          head -30 "$HOURLY_FILE_UTF8"
          exit 1
        fi
        echo "✓ Parent measure found"
        
        # Check for hour 1 measures as sample
        measures=("Measure_Hour1_Time" "Measure_Hour1_Temperature" "Measure_Hour1_Weather_Code" "Measure_Hour1_Is_Day")
        for measure in "${measures[@]}"; do
          if grep -q "$measure" "$HOURLY_FILE_UTF8"; then
            echo "✓ $measure found"
          else
            echo "ERROR: Missing $measure in 7HoursForecast.inc"
            echo "Showing lines containing 'Measure_' for debugging:"
            grep -n "Measure_" "$HOURLY_FILE_UTF8" | head -20
            exit 1
          fi
        done

  test-api:
    name: Test Open-Meteo API Integration
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      
    - name: Test API Endpoints
      run: |
        echo "Testing Open-Meteo API endpoints used in measures"
        
        # Extract latitude and longitude from sample configs (using default values)
        LAT="29.704813"
        LON="72.560036"
        
        # Test current weather endpoint
        CURRENT_URL="https://api.open-meteo.com/v1/forecast?latitude=$LAT&longitude=$LON&current=temperature_2m,weather_code,is_day"
        echo "Testing current weather endpoint: $CURRENT_URL"
        if curl -s --fail "$CURRENT_URL" > /dev/null; then
          echo "✓ Current weather API is accessible"
        else
          echo "WARNING: Current weather API is not accessible or returned an error"
        fi
        
        # Test daily forecast endpoint
        DAILY_URL="https://api.open-meteo.com/v1/forecast?latitude=$LAT&longitude=$LON&daily=weather_code,temperature_2m_max,temperature_2m_min"
        echo "Testing daily forecast endpoint: $DAILY_URL"
        if curl -s --fail "$DAILY_URL" > /dev/null; then
          echo "✓ Daily forecast API is accessible"
        else
          echo "WARNING: Daily forecast API is not accessible or returned an error"
        fi
        
        # Test hourly forecast endpoint
        HOURLY_URL="https://api.open-meteo.com/v1/forecast?latitude=$LAT&longitude=$LON&hourly=temperature_2m,weather_code,is_day"
        echo "Testing hourly forecast endpoint: $HOURLY_URL"
        if curl -s --fail "$HOURLY_URL" > /dev/null; then
          echo "✓ Hourly forecast API is accessible"
        else
          echo "WARNING: Hourly forecast API is not accessible or returned an error"
        fi

  lint:
    name: Lint Configuration Files
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      
    - name: Set up environment
      run: |
        # Set UTF-8 locale to handle different encodings
        echo "LANG=C.UTF-8" >> $GITHUB_ENV
        echo "LC_ALL=C.UTF-8" >> $GITHUB_ENV
        
    - name: Find Weather Measure Files
      id: find_files_lint
      run: |
        # Find the actual paths to the files
        WEATHER_MEASURES_DIR=$(find . -name "WeatherMeasures" -type d | head -1)
        echo "WEATHER_MEASURES_DIR=$WEATHER_MEASURES_DIR" >> $GITHUB_ENV
        
        if [ -n "$WEATHER_MEASURES_DIR" ]; then
          echo "✓ Found WeatherMeasures directory at $WEATHER_MEASURES_DIR"
        else
          echo "✗ Could not find WeatherMeasures directory"
          exit 1
        fi
      
    - name: Check for Syntax Issues
      run: |
        echo "Checking for common syntax issues in .inc files"
        
        # Process each .inc file, converting UTF-16 to UTF-8 if needed
        INC_FILES=$(find "$WEATHER_MEASURES_DIR" -name "*.inc")
        for file in $INC_FILES; do
          echo "Checking $file"
          
          # Convert UTF-16 to UTF-8 if needed
          if file "$file" | grep -q "UTF-16"; then
            echo "  Converting UTF-16 to UTF-8 for processing"
            TEMP_FILE=$(mktemp)
            iconv -f UTF-16LE -t UTF-8 "$file" > "$TEMP_FILE"
            PROCESSED_FILE="$TEMP_FILE"
          else
            PROCESSED_FILE="$file"
          fi
          
          # Count opening and closing brackets
          open_brackets=$(grep -o "\[" "$PROCESSED_FILE" | wc -l)
          close_brackets=$(grep -o "\]" "$PROCESSED_FILE" | wc -l)
          
          if [ "$open_brackets" -ne "$close_brackets" ]; then
            echo "WARNING: Unmatched brackets in $file - $open_brackets [ vs $close_brackets ]"
          else
            echo "✓ Balanced brackets in $file"
          fi
          
          # Clean up temp file if created
          if [ "$PROCESSED_FILE" != "$file" ]; then
            rm "$PROCESSED_FILE"
          fi
        done
        
        # Check for common issues with TimeStampFormat based on memory
        echo "Checking for TimeStampFormat issues..."
        # We need to check all files, converting as needed
        for file in $INC_FILES; do
          # Convert UTF-16 to UTF-8 if needed
          if file "$file" | grep -q "UTF-16"; then
            TEMP_FILE=$(mktemp)
            iconv -f UTF-16LE -t UTF-8 "$file" > "$TEMP_FILE"
            PROCESSED_FILE="$TEMP_FILE"
          else
            PROCESSED_FILE="$file"
          fi
          
          if grep -q "TimeStampFormat=%Y-%m-%d" "$PROCESSED_FILE"; then
            echo "WARNING: Found %Y-%m-%d TimeStampFormat which may cause issues with day name extraction"
            echo "See documentation: Rainmeter TimeStampFormat for Abbreviated Day Names"
          fi
          
          # Clean up temp file if created
          if [ "$PROCESSED_FILE" != "$file" ]; then
            rm "$PROCESSED_FILE"
          fi
        done
        
        # Check for WMO code 3 mapping issues based on memory
        echo "Checking for WMO code 3 mapping..."
        ISSUE_FOUND=false
        for file in $INC_FILES; do
          # Convert UTF-16 to UTF-8 if needed
          if file "$file" | grep -q "UTF-16"; then
            TEMP_FILE=$(mktemp)
            iconv -f UTF-16LE -t UTF-8 "$file" > "$TEMP_FILE"
            PROCESSED_FILE="$TEMP_FILE"
          else
            PROCESSED_FILE="$file"
          fi
          
          if grep -q "PartlyCloudyNight.png.*3\|3.*PartlyCloudyNight.png" "$PROCESSED_FILE"; then
            echo "ERROR: Incorrect WMO code 3 mapping found in $file - should map to Overcast.png"
            echo "See memory: Correct WMO weather code 3 mapping to Overcast.png"
            ISSUE_FOUND=true
          fi
          
          # Clean up temp file if created
          if [ "$PROCESSED_FILE" != "$file" ]; then
            rm "$PROCESSED_FILE"
          fi
        done
        
        if [ "$ISSUE_FOUND" = true ]; then
          exit 1
        else
          echo "✓ No WMO code 3 mapping issues found"
        fi

  release:
    name: Create Release Package
    runs-on: ubuntu-latest
    needs: [validate, test-api, lint]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      
    - name: Find Weather Measure Files
      id: find_files_release
      run: |
        # Find the actual paths to the files
        WEATHER_MEASURES_DIR=$(find . -name "WeatherMeasures" -type d | head -1)
        echo "WEATHER_MEASURES_DIR=$WEATHER_MEASURES_DIR" >> $GITHUB_ENV
        
        if [ -n "$WEATHER_MEASURES_DIR" ]; then
          echo "✓ Found WeatherMeasures directory at $WEATHER_MEASURES_DIR"
        else
          echo "✗ Could not find WeatherMeasures directory"
          exit 1
        fi
      
    - name: Prepare Release Assets
      run: |
        echo "Preparing release package"
        mkdir -p release/Includes/WeatherMeasures
        
        # Copy files from the actual directory location
        cp "$WEATHER_MEASURES_DIR"/*.inc release/Includes/WeatherMeasures/
        cp README.md release/ || echo "README.md not found in root"
        cp LICENSE.md release/ || echo "LICENSE.md not found in root"
        
        cd release
        zip -r Nurashade-WeatherMeasures.zip .
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## Automated Release
          
          This release was automatically generated by the CI workflow.
          
          ### Changes in this release:
          - Updated weather measures
          - Validated API integration
          - Passed all linting checks
          
          ### Files included:
          - CurrentForecast.inc
          - 7DaysForecast.inc
          - 7HoursForecast.inc
          - Documentation and license files
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/Nurashade-WeatherMeasures.zip
        asset_name: Nurashade-WeatherMeasures-v${{ github.run_number }}.zip
        asset_content_type: application/zip