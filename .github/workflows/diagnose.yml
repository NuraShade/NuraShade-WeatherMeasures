name: Diagnose File Issues

on:
  push:
    branches: [ main, develop ]

jobs:
  diagnose:
    name: Diagnose File Issues
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      
    - name: Diagnostic Tests
      run: |
        echo "=== DIAGNOSTIC TESTS FOR CurrentForecast.inc ==="
        
        FILE_PATH="./Includes/WeatherMeasures/CurrentForecast.inc"
        
        echo "1. Check if file exists:"
        if [ -f "$FILE_PATH" ]; then
          echo "✓ File exists"
        else
          echo "✗ File does not exist"
          exit 1
        fi
        
        echo "2. Check file size and line count:"
        echo "File size: $(wc -c < "$FILE_PATH") bytes"
        echo "Line count: $(wc -l < "$FILE_PATH") lines"
        
        echo "3. Check file encoding:"
        file "$FILE_PATH"
        
        echo "4. Check for BOM or special characters:"
        head -1 "$FILE_PATH" | hexdump -C
        
        echo "5. Display first 20 lines of file:"
        head -20 "$FILE_PATH"
        
        echo "6. Try different grep approaches:"
        
        echo "  a. Standard grep:"
        if grep -q "Measure_Weather_Current_Parent" "$FILE_PATH"; then
          echo "    ✓ Standard grep found the string"
        else
          echo "    ✗ Standard grep did not find the string"
        fi
        
        echo "  b. Case-sensitive grep:"
        if grep -q "measure_weather_current_parent" "$FILE_PATH"; then
          echo "    ✓ Case-sensitive grep found lowercase version"
        else
          echo "    ✗ Case-sensitive grep did not find lowercase version"
        fi
        
        echo "  c. Case-insensitive grep:"
        if grep -qi "measure_weather_current_parent" "$FILE_PATH"; then
          echo "    ✓ Case-insensitive grep found the string"
        else
          echo "    ✗ Case-insensitive grep did not find the string"
        fi
        
        echo "  d. Literal string search:"
        if grep -F "Measure_Weather_Current_Parent" "$FILE_PATH"; then
          echo "    ✓ Literal string search found the string"
          echo "    Line found:"
          grep -n -F "Measure_Weather_Current_Parent" "$FILE_PATH"
        else
          echo "    ✗ Literal string search did not find the string"
        fi
        
        echo "  e. Search with different line ending handling:"
        if grep -qz "Measure_Weather_Current_Parent" "$FILE_PATH"; then
          echo "    ✓ grep with -z found the string"
        else
          echo "    ✗ grep with -z did not find the string"
        fi
        
        echo "7. Check for hidden characters around the measure name:"
        # Look for the specific pattern we expect
        if grep -E "\\[Measure_Weather_Current_Parent\\]" "$FILE_PATH"; then
          echo "    ✓ Found measure with brackets"
        else
          echo "    ✗ Did not find measure with brackets"
        fi
        
        echo "8. Show all lines containing 'Measure_' to see what measures exist:"
        grep -n "Measure_" "$FILE_PATH" | head -10
        
        echo "9. Set LANG environment variable and try again:"
        export LANG=C.UTF-8
        if grep -q "Measure_Weather_Current_Parent" "$FILE_PATH"; then
          echo "    ✓ With LANG=C.UTF-8, grep found the string"
        else
          echo "    ✗ Even with LANG=C.UTF-8, grep did not find the string"
        fi